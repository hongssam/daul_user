<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="egovframework.com.user.mapper.UserMapper">
	
	<select id="selectKakaoAccount" resultType="int">
		SELECT COUNT(*)
		  FROM daul.user
		 WHERE channel = 'kakao'
		   AND kakao_key = #{id}
	</select>
	
	<insert id="insertKakaoUser">
		INSERT INTO daul.user
			 (
			   user_id
			 , name
			 , pw
			 , email
			 , phone
			 , channel
			 , reg_date
			 , last_login_date
			 <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(email_chk)">
			 , email_chk 
			 </if>
			 <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(talk_chk)">
			 , talk_chk 
			 </if>
			 <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(sms_chk)">
			 , sms_chk 
			 </if>
			 , auth_type
			 , kakao_key
			 )
		VALUES 
			 (
			   #{user_id}
			 , #{name}
			 , #{pw}
			 , #{email}
			 , #{phone}
			 , #{channel}
			 , SYSDATE()
			 , SYSDATE()
			 <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(email_chk)">
			 , #{email_chk} 
			 </if>
			 <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(talk_chk)">
			 , #{talk_chk} 
			 </if>
			 <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(sms_chk)">
			 , #{sms_chk} 
			 </if>
			 , #{auth_type}
			 , #{kakao_key}
			 )
	</insert>
	
	<select id="selectUserIdCheck" resultType="int">
		SELECT COUNT(*)
		  FROM daul.user
		 WHERE user_id = #{user_id}
	</select>
	
	<insert id="insertPublicUser">
		INSERT INTO daul.user
			 (
			   user_id
			 , name
			 , pw
			 , email
			 , phone
			 , channel
			 , reg_date
			 , last_login_date
			 <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(email_chk)">
			 , email_chk 
			 </if>
			 <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(talk_chk)">
			 , talk_chk 
			 </if>
			 <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(sms_chk)">
			 , sms_chk 
			 </if>
			 , auth_type
			 )
		VALUES 
			 (
			   #{user_id}
			 , #{name}
			 , #{pw}
			 , #{email}
			 , #{phone}
			 , #{channel}
			 , SYSDATE()
			 , SYSDATE()
			 <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(email_chk)">
			 , #{email_chk} 
			 </if>
			 <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(talk_chk)">
			 , #{talk_chk} 
			 </if>
			 <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(sms_chk)">
			 , #{sms_chk} 
			 </if>
			 , #{auth_type}
			 )
	</insert>
	
	<select id="selectUser" resultType="egovframework.com.user.vo.UserVo">
		SELECT user_id
		     , name
		     , pw
		     , email
		     , phone
		     , channel
		     , DATE_FORMAT(reg_date, '%Y-%m-%d')		as reg_date
     		 , DATE_FORMAT(last_login_date, '%Y-%m-%d') as last_login_date
		     , email_chk
		     , talk_chk
		     , sms_chk
		     , auth_type
		     , kakao_key
		  FROM daul.user
		 WHERE user_id = #{user_id}
	</select>
	
	<update id="updateUser">
		UPDATE daul.user
		   SET user_id = #{user_id}
		     <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(pw)">
		     , pw = #{pw}
		     </if>
		     <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(name)">
		     , name = #{name}
		     </if>
		     <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(email)">
		     , email = #{email}
		     </if>
		     <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(email_chk)">
		     , email_chk = #{email_chk}
		     </if>
		     <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(talk_chk)">
		     , talk_chk = #{talk_chk}
		     </if>
		     <if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(sms_chk)">
		     , sms_chk = #{sms_chk}
		     </if>
		 WHERE user_id = #{user_id}
	</update>
	
	<sql id="whereBySuggestion">
		<if test="@egovframework.com.cmmn.util.StringUtil@equals(search_type, 'title')">
			AND title like concat('%', #{search}, '%')
		</if>
		<if test="@egovframework.com.cmmn.util.StringUtil@equals(search_type, 'content')">
			AND content like concat('%', #{search}, '%')
		</if>
		<if test="@egovframework.com.cmmn.util.StringUtil@equals(search_type, 'create_user')">
			AND create_user like concat('%', #{search}, '%')
		</if>
		<if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(search_s_date)">
			<![CDATA[
			AND create_date >= date_format(concat(#{search_s_date}, ' 00:00:00'), '%Y-%m-%d %H:%i:%s')
			]]>
		</if>
		<if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(search_e_date)">
			<![CDATA[
			AND create_date <= date_format(concat(#{search_e_date}, ' 23:59:59'), '%Y-%m-%d %H:%i:%s')
			]]>
		</if>
	</sql>
	
	<select id="selectSuggestionListCntByMypage" resultType="int">
		SELECT COUNT(*) 
		  FROM (
		  		SELECT sm.*
		  		     , CASE WHEN (like_count / 50 * 100) >= 100 THEN 100 ELSE (like_count / 50 * 100) END AS like_per
		  		  FROM (
						SELECT suggestion_idx
							 , title
							 , content
							 , (SELECT COUNT(*) FROM daul.user_like where parent_idx = s.suggestion_idx) AS like_count
							 , create_user
							 , DATE_FORMAT(create_date, '%Y-%m-%d') as create_date
							 , (SELECT count(*) FROM suggestion_opinion a WHERE a.suggestion_idx = s.suggestion_idx) AS opinion_cnt
						  FROM suggestion_main s
						 WHERE del_chk != 'Y'
						   AND create_user = #{create_user}
						   <include refid="whereBySuggestion"/>
		  		  	   ) sm
		       ) sub
	</select>
	
	<select id="selectSuggestionListByMypage" resultType="egovframework.com.suggestion.vo.SuggestionVo">
		SELECT @rownum:=@rownum+1 AS num
  		     , sub.suggestion_idx
  		     , sub.title
  		     , sub.content
  		     , sub.like_count
  		     , sub.create_user
  		     , DATE_FORMAT(sub.create_date, '%Y-%m-%d %H:%i:%s') as create_date
  		     , sub.opinion_cnt
  		     , sub.like_per
		  FROM (
		  		SELECT sm.*
		  		     , CASE WHEN (like_count / 50 * 100) >= 100 THEN 100 ELSE (like_count / 50 * 100) END AS like_per
		  		  FROM (
						SELECT suggestion_idx
							 , title
							 , content
							 , (SELECT COUNT(*) FROM daul.user_like where parent_idx = s.suggestion_idx) AS like_count
							 , create_user
							 , create_date
							 , (SELECT count(*) FROM suggestion_opinion a WHERE a.suggestion_idx = s.suggestion_idx) AS opinion_cnt
						  FROM suggestion_main s
						 WHERE del_chk != 'Y'
						   AND create_user = #{create_user}
						   <include refid="whereBySuggestion"/>
		  		  	   ) sm
		  		 ORDER BY sm.create_date
		       ) sub
		     , (SELECT @rownum:=0) TMP
		 ORDER BY num DESC
		 LIMIT #{startIndex}, #{pageSize}
	</select>
	
	<sql id="whereBySurvey">
		<if test="@egovframework.com.cmmn.util.StringUtil@equals(search_type, 'title')">
			 AND title like concat('%', #{search}, '%')
		</if>
		<if test="@egovframework.com.cmmn.util.StringUtil@equals(search_type, 'content')">
			 AND content like concat('%', #{search}, '%')
		</if>
		<if test="@egovframework.com.cmmn.util.StringUtil@equals(search_type, 'create_user')">
			 AND create_user like concat('%', #{search}, '%')
		</if>
		<if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(search_s_date)">
			 <![CDATA[
			AND create_date >= date_format(concat(#{search_s_date}, ' 00:00:00'), '%Y-%m-%d %H:%i:%s')
			]]>
		</if>
		<if test="@egovframework.com.cmmn.util.StringUtil@isNotEmpty(search_e_date)">
			 <![CDATA[
			AND create_date <= date_format(concat(#{search_e_date}, ' 23:59:59'), '%Y-%m-%d %H:%i:%s')
			]]>
		</if>
	</sql>
	
	<select id="selectSurveyListCntByMypage" resultType="int">
		SELECT COUNT(*)
		  FROM survey_main sm
		 INNER JOIN (
		  			 SELECT survey_idx 
		  			   FROM daul.survey_participation 
		  			  WHERE participation_user = #{create_user} 
		  			  GROUP BY survey_idx
		  			) sp ON sp.survey_idx = sm.survey_idx
		  	 , (SELECT @rownum:=0) TMP
		 WHERE sm.del_chk != 'Y'
		 <include refid="whereBySurvey"/>
	</select>
	
	<select id="selectSurveyListByMypage" resultType="egovframework.com.survey.vo.SurveyVo">
		SELECT @rownum:=@rownum+1 					AS num
			 , sm.survey_idx
		     , sm.title
		     , sm.content
		     , DATE_FORMAT(sm.s_date, '%Y-%m-%d')	AS s_date
		     , DATE_FORMAT(sm.e_date, '%Y-%m-%d')	AS e_date
		     , sm.create_user
		     , (SELECT COUNT(*) FROM survey_opinion WHERE survey_idx = sm.survey_idx )			AS opinion_cnt
		     , (SELECT COUNT(*) FROM survey_participation WHERE survey_idx = sm.survey_idx )	AS participation_count
		     <![CDATA[
		     , (CASE WHEN e_date < SYSDATE() 					   THEN '투표완료'
		 		    WHEN s_date > SYSDATE() 					   THEN '투표전'
			 	    WHEN e_date > SYSDATE() AND SYSDATE() > s_date THEN '투표중'
			    END) AS ing
			 ]]>
		  FROM survey_main sm
		 INNER JOIN (
		  			 SELECT survey_idx 
		  			   FROM daul.survey_participation 
		  			  WHERE participation_user = #{create_user} 
		  			  GROUP BY survey_idx
		  			) sp ON sp.survey_idx = sm.survey_idx
		  	 , (SELECT @rownum:=0) TMP
		 WHERE sm.del_chk != 'Y'
		 <include refid="whereBySurvey"/>
		 LIMIT #{startIndex}, #{pageSize}
	</select>
</mapper>